<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="\u3000在学校的服务器使用过程中，需要服务器访问外网，但在服务器上可能没有权限创建代理网络，或者不方便使用。而且直接使用服务器访问外网也可能有风险，因此，本文通过ssh隧道，将服务器的网络代理到我们的终端主机，也就是我们自己的电脑上，再在自己的电脑上安装代理软件，实现服务器通过ssh隧道访问外网的功能。\n"><meta name=keywords content="SSH Tunnel,Linux,Proxy"><title>个人Linux主机通过SSH隧道使服务器访问外网</title>
<link rel=canonical href=https://codetang-2417.github.io/p/%E4%B8%AA%E4%BA%BAlinux%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87ssh%E9%9A%A7%E9%81%93%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="个人Linux主机通过SSH隧道使服务器访问外网"><meta property='og:description' content="\u3000在学校的服务器使用过程中，需要服务器访问外网，但在服务器上可能没有权限创建代理网络，或者不方便使用。而且直接使用服务器访问外网也可能有风险，因此，本文通过ssh隧道，将服务器的网络代理到我们的终端主机，也就是我们自己的电脑上，再在自己的电脑上安装代理软件，实现服务器通过ssh隧道访问外网的功能。\n"><meta property='og:url' content='https://codetang-2417.github.io/p/%E4%B8%AA%E4%BA%BAlinux%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87ssh%E9%9A%A7%E9%81%93%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91/'><meta property='og:site_name' content='LingLong'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Network'><meta property='article:tag' content='Manjaro'><meta property='article:tag' content='Linux'><meta property='article:published_time' content='2024-10-20T18:50:54+08:00'><meta property='article:modified_time' content='2024-10-31T16:29:40+08:00'><meta name=twitter:title content="个人Linux主机通过SSH隧道使服务器访问外网"><meta name=twitter:description content="\u3000在学校的服务器使用过程中，需要服务器访问外网，但在服务器上可能没有权限创建代理网络，或者不方便使用。而且直接使用服务器访问外网也可能有风险，因此，本文通过ssh隧道，将服务器的网络代理到我们的终端主机，也就是我们自己的电脑上，再在自己的电脑上安装代理软件，实现服务器通过ssh隧道访问外网的功能。\n"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_7866f48be1497b78.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>LingLong</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/codetang-2417/ target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#本机代理配置>本机代理配置</a></li><li><a href=#ssh隧道>SSH隧道</a><ol><li><a href=#正向-ssh-隧道>正向 SSH 隧道</a></li><li><a href=#反向-ssh-隧道>反向 SSH 隧道</a></li><li><a href=#动态转发-ssh-隧道>动态转发 SSH 隧道</a></li><li><a href=#常用参数>常用参数</a></li></ol></li><li><a href=#应用>应用</a><ol><li><a href=#本机配置>本机配置</a></li><li><a href=#远程服务器配置>远程服务器配置</a></li></ol></li><li><a href=#设置好后不能正常联网>设置好后不能正常联网</a></li><li><a href=#重新建立ssh-隧道后服务器无法访问外网>重新建立SSH 隧道后服务器无法访问外网</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E7%B3%BB%E7%BB%9F%E7%BB%B4%E6%8A%A4/ style=background-color:#c6ebc5;color:#fff>系统维护
</a><a href=/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/ style=background-color:#fa7070;color:#fff>网络安全</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E4%B8%AA%E4%BA%BAlinux%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87ssh%E9%9A%A7%E9%81%93%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91/>个人Linux主机通过SSH隧道使服务器访问外网</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 20, 2024</time></div></footer></div></header><section class=article-content><p>　　在学校的服务器使用过程中，需要服务器访问外网，但在服务器上可能没有权限创建代理网络，或者不方便使用。而且直接使用服务器访问外网也可能有风险，因此，本文通过ssh隧道，将服务器的网络代理到我们的终端主机，也就是我们自己的电脑上，再在自己的电脑上安装代理软件，实现服务器通过ssh隧道访问外网的功能。</p><h2 id=本机代理配置>本机代理配置</h2><p>　　本文中 “<strong>本机”</strong> 一词代表个人电脑，<strong>服务器</strong> 代表远程连接的服务器电脑。</p><p>　　本机系统如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ neofetch                                                                                                                                                              ✔ 
</span></span><span class=line><span class=cl>██████████████████  ████████   ling@ling-20ym 
</span></span><span class=line><span class=cl>██████████████████  ████████   -------------- 
</span></span><span class=line><span class=cl>██████████████████  ████████   OS: Manjaro Linux x86_64 
</span></span><span class=line><span class=cl>██████████████████  ████████   Host: 20YM Lenovo ThinkBook 16p Gen <span class=m>2</span> 
</span></span><span class=line><span class=cl>████████            ████████   Kernel: 6.1.112-1-MANJARO 
</span></span><span class=line><span class=cl>████████  ████████  ████████   Uptime: <span class=m>9</span> hours, <span class=m>57</span> mins 
</span></span><span class=line><span class=cl>████████  ████████  ████████   Packages: <span class=m>1772</span> <span class=o>(</span>pacman<span class=o>)</span> 
</span></span><span class=line><span class=cl>████████  ████████  ████████   Shell: bash 5.2.37 
</span></span><span class=line><span class=cl>████████  ████████  ████████   Resolution: 2560x1600, 2560x1440 
</span></span><span class=line><span class=cl>████████  ████████  ████████   DE: Plasma 6.1.5 
</span></span><span class=line><span class=cl>████████  ████████  ████████   WM: KWin 
</span></span><span class=line><span class=cl>████████  ████████  ████████   Theme: <span class=o>[</span>Plasma<span class=o>]</span>, Breeze <span class=o>[</span>GTK2/3<span class=o>]</span> 
</span></span><span class=line><span class=cl>████████  ████████  ████████   Icons: <span class=o>[</span>Plasma<span class=o>]</span>, McMojave-circle-dark <span class=o>[</span>GTK2/3<span class=o>]</span> 
</span></span><span class=line><span class=cl>████████  ████████  ████████   Terminal: konsole 
</span></span><span class=line><span class=cl>                               CPU: AMD Ryzen <span class=m>7</span> 5800H with Radeon Graphics <span class=o>(</span>16<span class=o>)</span> @ 3.200GHz 
</span></span><span class=line><span class=cl>                               GPU: AMD ATI Radeon Vega Series / Radeon Vega Mobile Series 
</span></span><span class=line><span class=cl>                               GPU: NVIDIA GeForce RTX <span class=m>3060</span> Mobile / Max-Q 
</span></span><span class=line><span class=cl>                               Memory: 18054MiB / 23392MiB 
</span></span></code></pre></td></tr></table></div></div><p>　　采用clash verge作为代理软件，该软件能够开放本地端口作为代理访问路径，为ssh隧道提供了出口端口。</p><p>　　本人使用tun模式，尽可能的避免DNS泄漏。如果使用代理模式也可以。但 Linux上只有少数程序会走系统代理模式，除了在需要在clash verge中开启代理模式，还需要在对应的软件中手动设置代理。因此还是tun模式更适合linux上使用。参考：<a class=link href=https://github.com/clash-verge-rev/clash-verge-rev/issues/346 target=_blank rel=noopener>Ubuntu下系统代理只能作用于Firefox？</a></p><p>　　注：开启代理模式后，即便本机其他程序不走clash，我们通过ssh建立隧道依然可行。</p><p>​<img src=/p/%E4%B8%AA%E4%BA%BAlinux%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87ssh%E9%9A%A7%E9%81%93%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91/assets/image-20241020185708-5yl00rv.png width=740 height=836 loading=lazy alt=image class=gallery-image data-flex-grow=88 data-flex-basis=212px>​</p><p>　　这里开启tun模式后，并保证本机能够正常访问外网后，就可以开始ssh隧道搭建。需要注意，clash verge默认开放的代理端口为7897，可以自行修改。</p><h2 id=ssh隧道>SSH隧道</h2><p>　　参考：<a class=link href=https://www.entropy-tree.top/2024/04/18/ssh-tunneling-techniques/ target=_blank rel=noopener>SSH 隧道技术</a>、<a class=link href=https://cloud.tencent.com/developer/article/1901554 target=_blank rel=noopener>SSH隧道详解与使用AutoSSH实现稳定的内网穿透</a>、<a class=link href=https://www.lixueduan.com/posts/linux/07-ssh-tunnel/#%E6%89%A9%E5%B1%95-%E8%B7%A8%E6%9C%BA%E5%99%A8%E8%BD%AC%E5%8F%91 target=_blank rel=noopener>SSH 隧道简明教程</a></p><p>　　SSH隧道提供三种模式：正向 SSH 隧道（本地转发）、反向 SSH 隧道（远程转发）、动态转发 SSH 隧道（Socket服务器）。</p><p>　　由于一台电脑上可能有多个网卡（意味着有多个 IP），因此在使用 SSH 隧道时，需要指定：1. 从哪一个 IP建立SSH连接。也就是SSH的登陆地址。2. SSH隧道应该连接到哪一个 IP上。也就是<strong>隧道地址</strong>。</p><p>　　在下面的介绍中，destination 表示服务器的地址，也就是登陆服务器的标识符：<strong>Username@Host_IP</strong>，host:hostport 表示服务器上的隧道地址。host可以和Host_IP不同，但都是服务器上的IP地址。</p><h3 id=正向-ssh-隧道>正向 SSH 隧道</h3><p>　　将本主机上的某网络端口上的所有流量，通过 SSH 隧道转发到远程服务器上的网络端口。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -L <span class=o>[</span>bind_address:<span class=o>]</span>port:host:hostport destination
</span></span></code></pre></td></tr></table></div></div><p>　　其中 bind_address 可选（默认为 localhost），是本机上的一个网络ip。该命令会本地开启一个绑定在 [bind_address:]port 上的套接字，并监听。将该套接字上所有的流量都转发到 destination 服务器上的 host:hostport。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -L 9090:localhost:8080 root@10.0.0.2
</span></span></code></pre></td></tr></table></div></div><p>　　例如，这个例子就是将本机 localhost:9090 上的流量转发到 10.0.0.2 服务器上的 localhost:8080。</p><h3 id=反向-ssh-隧道>反向 SSH 隧道</h3><p>　　将远程服务器上的网络端口上的所有流量，通过 SSH 隧道转发到本主机上的某网络端口。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -R <span class=o>[</span>bind_address:<span class=o>]</span>port:host:hostport destination
</span></span></code></pre></td></tr></table></div></div><p>　　和正向隧道的命令行格式相同，不同点在于此命令是在服务器上开启一个绑定在 host:hostport 上的套接字，并监听。将该套接字上所有的流量都转发到 <strong>本机</strong> 上的 [bind_address:]port。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -R 9090:localhost:8080 root@10.0.0.2
</span></span></code></pre></td></tr></table></div></div><p>　　例如，这个例子就是将10.0.0.2 服务器上的 localhost:8080 上的流量转发到本机 localhost:9090。</p><h3 id=动态转发-ssh-隧道>动态转发 SSH 隧道</h3><p>　　动态转发 SSH 隧道实际上是将远程服务器作为一个 Socket 服务器，专门转发本地端口上的所有流量到<strong>服务器所处的网络中</strong>。动态转发不像正向隧道与反向隧道一样转发端口与目标端口是一对一的，<strong>动态转发中的转发端口对应的目标是目标主机所在的整个网络</strong>。不过使用动态转发访问目标主机所在网络时需要应用程序本身支持代理配置或者使用socket代理工具。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -D <span class=o>[</span>bind_address:<span class=o>]</span>port destination
</span></span></code></pre></td></tr></table></div></div><p>　　-D [bind_address:]port 指定监听的端口，会在本地监听该端口，并将请求到该端口流量基于 SOCKS5 协议转发到远程主机上，其中 [bind_address:]可以不填，当不写或者为 * 时表示监听全部地址。示例:-D *:8081,-D 8081,-D 127.0.0.1:8081,-D 192.168.0.1:8081。</p><p>　　可以参考：<a class=link href=https://www.lixueduan.com/posts/linux/07-ssh-tunnel/#%E6%89%A9%E5%B1%95-%E8%B7%A8%E6%9C%BA%E5%99%A8%E8%BD%AC%E5%8F%91 target=_blank rel=noopener>SSH 隧道简明教程</a> 中<code>扩展-跨机器转发</code>​章节，介绍的很清楚。</p><p>　　下面是从中截出的两张图片，主要应用是在A与B之间创建隧道，最终通过隧道访问到ServerC中的 http 服务。</p><p>​<img src=/p/%E4%B8%AA%E4%BA%BAlinux%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87ssh%E9%9A%A7%E9%81%93%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91/assets/image-20241020215213-kvxoreu.png width=1244 height=598 loading=lazy alt=image class=gallery-image data-flex-grow=208 data-flex-basis=499px>​</p><p>　　最常用的就是绕过防火墙，在外网上通过一台可以访问内网的 Server A，访问内容。基于Socket协议的翻墙软件就是这个原理，用一台没被墙的、在国内可以通过SSH访问到的VPS，作为Socket服务器，也就是图中的 Server B。VPS在国外，可以访问国外网络资源，国内就将所有的外网网络请求发往 Server A的SSH 绑定端口，Server A会将其转发给国外网络，例如入中的 Server C。由于 Server A 到 Server B之间是SSH加密传输的，防火墙看不到其中具体访问的网络内容，就不会判断为翻墙。但由于这种方式应用太广泛，现在检测流量特征的手段很强，可以快速判断出并封掉。</p><p>​<img src=/p/%E4%B8%AA%E4%BA%BAlinux%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87ssh%E9%9A%A7%E9%81%93%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91/assets/image-20241020215222-0qvsdqk.png width=946 height=676 loading=lazy alt=image class=gallery-image data-flex-grow=139 data-flex-basis=335px>​</p><h3 id=常用参数>常用参数</h3><ul><li>​<code>-L</code>​：local，表示使用本地端口转发创建 ssh 隧道</li><li>​<code>-R</code>​：remote，表示使用远程端口转发创建 ssh 隧道</li><li>​<code>-D</code>​：dynamic，表示使用动态端口转发创建 ssh 隧道</li><li>​<code>-N</code>​： 表示创建隧道以后不连接到 sshServer端，通常与”-f”选项连用</li><li>​<code>-f</code>​：表示在后台运行ssh隧道，通常与”-N”选项连用</li><li>​<code>-q</code>​ 参数用于启用 <strong>静默模式</strong>（quiet mode）</li><li>​<code>-g</code>​：表示 ssh 隧道对应的转发端口将监听在主机的所有IP中，不使用”-g选项”时，转发端口默认只监听在主机的本地回环地址中，”-g” 表示开启网关模式，远程端口转发中，无法开启网关功能</li><li>​<code>-C</code>​：启用压缩，可以提高传输速度。</li><li>​<code>-p port</code>​：指定 SSH 服务器监听的端口 (如果不是默认的22端口)。</li><li>​<code>-i 私钥文件</code>​：使用指定的私钥文件进行身份验证。</li><li>​<code>-T</code>​ ：用于禁用伪终端分配，使用 <code>-N</code>​ 时，因为本身就没有需要交互的命令，SSH 默认不会分配伪终端，便不需要 <code>-T</code>​</li></ul><h2 id=应用>应用</h2><p>　　为了达到我们的目的：将服务器上的网络代理到本机上，我们有两种方案：</p><ol><li>建立反向隧道，将服务器端口上的流量转发到本机，服务器上所有的流量都走代理端口。优点是：比较简单，只需要ssh建立隧道即可，不需要安装其他软件，只要主机能访问外网，服务器就可以。缺点是：如果有其他服务器，需要在主机上为每一个服务器都单独创建SSH隧道。如果主机下线了，服务器就无法访问外网了。</li><li>建立 Socket服务器，让服务器的所有流量都走 Socket服务器。但这样的话和建立一个翻墙代理的区别就会很小了，不如直接就在服务器上安装代理软件。优点是：更安全，代理管理起来更方便。一般来说Socket服务器不会轻易下线，保证服务器一直有外网网络。缺点是：每一台服务器上都需要单独配置软件，且Socket服务器需要在外网。</li></ol><p>　　对于普通的应用场景来说，在自己的电脑上，我们都会安装代理软件，在服务器管理员没有配置跳板机或者跳板机故障时，我们就可以采用第一种，快速 实现 or 恢复 服务器访问外部网络。</p><p>　　我们假设服务器的ip为10.0.0.2，服务器上有用户名为 server的用户。</p><h3 id=本机配置>本机配置</h3><p>　　本机上我们安装clash verge，正常启动后，就会clash verge就会监听 localhost:7897，并转发流量到代理服务器。本示例为方便起见，将主机和远程服务器的端口都设置为 7897，实际上远程服务器可以设置为其他没有被使用的端口，主机也可以在clash verge中将代理端口改为其他端口后，将SSH隧道的本地端口同步修改。</p><p>　　运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -R 7897:localhost:7897 -fqCN server@10.0.0.2
</span></span></code></pre></td></tr></table></div></div><p>　　为远程服务器的 localhost:7897 和本机的 localhost:7897建立ssh隧道。转发方向为：远程服务器 SSH隧道 -> 本机 localhost:7897 -> clash verge。</p><p>　　​<code>-fqCN</code>​：后台运行、静默模式、启动压缩模式，加快速度、只转发端口，不连接终端。</p><h3 id=远程服务器配置>远程服务器配置</h3><p>　　远程服务器上需要在终端中添加代理变量，也可以写到终端变量文件（~/.bashrc 或者 ~/.profile ）中，每次登陆自动生效。使得所有的流量走代理端口，也就是本地回环地址的7897端口。转发方向：服务器其他网络 -> 服务器 localhost的7897端口 -> 服务器SSH隧道</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>http_proxy</span><span class=o>=</span><span class=s2>&#34;localhost:7897&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>https_proxy</span><span class=o>=</span><span class=s2>&#34;localhost:7897&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=设置好后不能正常联网>设置好后不能正常联网</h2><p>　　在实践过程中，我遇到了按照上述配置后，主机网络正常访问外网，服务器和主机之间SSH隧道通信正常，但服务器无法访问外网。如下：</p><p>　　服务器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -x socks5://localhost:7897 https://www.google.com
</span></span><span class=line><span class=cl>curl: <span class=o>(</span>35<span class=o>)</span> error:0A000126:SSL routines::unexpected eof <span class=k>while</span> reading
</span></span></code></pre></td></tr></table></div></div><p>　　添加参数 <code>-v</code>​ 打印详细日志输出，可以看到使用了本地的DNS解析地址。但国内的DNS在没被代理的时候，会被CFW污染，因此这个地址实际上不是谷歌的服务器IP，但由于已经缓存下来了，所以在访问的时候会通过该IP来访问。于是，传递给代理的ip也是这个错误ip，就会导致访问出错。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -v -x socks5://localhost:7897 https://www.google.com
</span></span><span class=line><span class=cl>*   Trying 127.0.0.1:7897...
</span></span><span class=line><span class=cl>* SOCKS5 connect to IPv4 199.59.148.229:443 <span class=o>(</span>locally resolved<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>　　解决办法：</p><ol><li><p>等几分钟中&mldr;等DNS缓存过期。</p></li><li><p>安装 proxychain，并在其中配置<code>proxy_dns</code>​，使得DNS也通过代理查询。</p><p>配置 proxychain</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vim /etc/proxychains.conf
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=c1># Proxy DNS requests - no leak for DNS data</span>
</span></span><span class=line><span class=cl>proxy_dns
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>[</span>ProxyList<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># add proxy here ...</span>
</span></span><span class=line><span class=cl><span class=c1># meanwile</span>
</span></span><span class=line><span class=cl><span class=c1># defaults set to &#34;tor&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>https  127.0.0.1 <span class=m>7897</span>
</span></span><span class=line><span class=cl>socks5 127.0.0.1 <span class=m>7897</span>
</span></span></code></pre></td></tr></table></div></div><p>通过 proxychain 访问</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ proxychains curl -I https://www.youtube.com
</span></span></code></pre></td></tr></table></div></div></li><li><p>在使用 systemd 管理服务的 Linux 上。可以通过重启系统解析服务来情况 DNS 缓存 <code>sudo systemctl restart systemd-resolved</code>​。</p></li></ol><p>　　正常情况下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -v -x socks5://localhost:7897 https://www.google.com                                                                                                                              
</span></span><span class=line><span class=cl>*   Trying 127.0.0.1:7897...                                                                                                                                                                                                  
</span></span><span class=line><span class=cl>* SOCKS5 connect to IPv4 31.13.94.41:443 <span class=o>(</span>locally resolved<span class=o>)</span>                                                                                                                                                                   
</span></span><span class=line><span class=cl>* SOCKS5 request granted.                                                                                                                                                                                                     
</span></span><span class=line><span class=cl>* Connected to <span class=o>(</span>nil<span class=o>)</span> <span class=o>(</span>127.0.0.1<span class=o>)</span> port <span class=m>7897</span> <span class=o>(</span><span class=c1>#0)                                                                                                                                                                               </span>
</span></span><span class=line><span class=cl>* ALPN, offering h2                                                                                                                                                                                                           
</span></span><span class=line><span class=cl>* ALPN, offering http/1.1                                                                                                                                                                                                     
</span></span><span class=line><span class=cl>*  CAfile: /etc/ssl/certs/ca-certificates.crt                                                                                                                                                                                 
</span></span><span class=line><span class=cl>*  CApath: /etc/ssl/certs                                                                                                                                                                                                     
</span></span><span class=line><span class=cl>* TLSv1.0 <span class=o>(</span>OUT<span class=o>)</span>, TLS header, Certificate Status <span class=o>(</span>22<span class=o>)</span>:                                                                                                                                                                         
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>OUT<span class=o>)</span>, TLS handshake, Client hello <span class=o>(</span>1<span class=o>)</span>:                                                                                                                                                                             
</span></span><span class=line><span class=cl>* TLSv1.2 <span class=o>(</span>IN<span class=o>)</span>, TLS header, Certificate Status <span class=o>(</span>22<span class=o>)</span>:                                                                                                                                                                          
</span></span><span class=line><span class=cl>* TLSv1.3 <span class=o>(</span>IN<span class=o>)</span>, TLS handshake, Server hello <span class=o>(</span>2<span class=o>)</span>:                                                                                                                                                                              
</span></span><span class=line><span class=cl>* TLSv1.2 <span class=o>(</span>IN<span class=o>)</span>, TLS header, Finished <span class=o>(</span>20<span class=o>)</span>:         
</span></span></code></pre></td></tr></table></div></div><h2 id=重新建立ssh-隧道后服务器无法访问外网>重新建立SSH 隧道后服务器无法访问外网</h2><p>　　可能会出现 SSH 隧道已经被清空，但服务器端还没有退出对应的线程的情况，这时需要我们手动找出对应的线程，并kill掉。再重新建立 SSH 隧道。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo lsof -i :7897
</span></span><span class=line><span class=cl>COMMAND     PID           USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
</span></span><span class=line><span class=cl>sshd    <span class=m>2129065</span> tiancheng.tang    7u  IPv6 <span class=m>48338339</span>      0t0  TCP ip6-localhost:7897 <span class=o>(</span>LISTEN<span class=o>)</span>
</span></span><span class=line><span class=cl>sshd    <span class=m>2129065</span> tiancheng.tang    9u  IPv4 <span class=m>48338340</span>      0t0  TCP localhost:7897 <span class=o>(</span>LISTEN<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>kill</span> <span class=m>2129065</span>
</span></span></code></pre></td></tr></table></div></div><p>　　如果需要长时间稳定使用SSH 隧道，可以使用autossh。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/network/>Network</a>
<a href=/tags/manjaro/>Manjaro</a>
<a href=/tags/linux/>Linux</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 Oct 31, 2024 16:29 +0800</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/linuxmanjaro%E5%AE%BF%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87virtualbox%E8%99%9A%E6%8B%9F%E6%9C%BAwin11%E8%BF%9E%E6%8E%A5vpn%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91/><div class=article-details><h2 class=article-title>Linux（Manjaro）宿主机通过virtualBox虚拟机win11连接vpn访问内网</h2></div></a></article><article><a href=/p/qbittorrent-%E6%A0%A1%E9%AA%8C%E5%A4%A7%E6%96%87%E4%BB%B6%E5%AF%BC%E8%87%B4linux%E5%86%85%E6%A0%B8%E5%87%BA%E9%97%AE%E9%A2%98/><div class=article-details><h2 class=article-title>qbittorrent 校验大文件导致Linux内核出问题</h2></div></a></article><article><a href=/p/time-%E5%90%8C%E6%AD%A5/><div class=article-details><h2 class=article-title>Time 同步</h2></div></a></article><article><a href=/p/ryzen%E9%9A%8F%E6%9C%BA%E5%8D%A1%E6%AD%BB%E9%97%AE%E9%A2%98/><div class=article-details><h2 class=article-title>Ryzen随机卡死问题</h2></div></a></article><article><a href=/p/sudo%E5%85%8D%E5%AF%86%E7%A0%81/><div class=article-details><h2 class=article-title>sudo免密码</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=codetang-2417/codetang-2417.github.io data-repo-id=R_kgDOMyu4sg data-category=Announcements data-category-id=DIC_kwDOMyu4ss4CiiW6 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 LingLong's Blog</section><section class=powerby>Simple is enough.<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>